---
phase: 04-wordpress-ai-discovery-plugin
plan: 02
type: execute
wave: 2
depends_on: [04-01]
files_modified:
  - wordpress-plugin/parkk-ai-discovery/includes/class-ai-responder.php
  - wordpress-plugin/parkk-ai-discovery/vendor/
autonomous: true
requirements: [PLUG-01, PLUG-02, PLUG-03, PLUG-04]

must_haves:
  truths:
    - "A request with AI bot User-Agent to a single post URL returns markdown content instead of HTML"
    - "A request with Accept: text/markdown header to a single post URL returns markdown content"
    - "Every markdown response includes the Parkk identity block at the bottom"
    - "Content-Signal and X-Markdown-Tokens headers are present on all markdown responses"
    - "Non-AI, non-markdown-requesting visitors see normal HTML pages unaffected"
  artifacts:
    - path: "wordpress-plugin/parkk-ai-discovery/includes/class-ai-responder.php"
      provides: "AI bot detection, HTML-to-markdown conversion, identity block, Content-Signal headers"
      contains: "template_redirect"
    - path: "wordpress-plugin/parkk-ai-discovery/vendor/autoload.php"
      provides: "Composer autoloader for league/html-to-markdown"
      contains: "autoload"
  key_links:
    - from: "wordpress-plugin/parkk-ai-discovery/includes/class-ai-responder.php"
      to: "wordpress-plugin/parkk-ai-discovery/includes/class-robots-manager.php"
      via: "Parkk_Robots_Manager::get_ai_user_agents() call"
      pattern: "Parkk_Robots_Manager::get_ai_user_agents"
    - from: "wordpress-plugin/parkk-ai-discovery/includes/class-ai-responder.php"
      to: "wordpress-plugin/parkk-ai-discovery/vendor/"
      via: "league/html-to-markdown HtmlConverter usage"
      pattern: "HtmlConverter"
---

<objective>
Build the AI bot markdown responder: detect AI user agents and Accept: text/markdown headers, convert WordPress post HTML to markdown, append the Parkk identity block, and serve with Content-Signal headers.

Purpose: This is the core AI discovery feature. When AI crawlers (GPTBot, ClaudeBot, etc.) visit any post, they receive clean markdown instead of HTML — reducing token usage ~80% and maximizing citation probability. Human visitors are completely unaffected.

Output: `class-ai-responder.php` class file and vendored `league/html-to-markdown` library.
</objective>

<execution_context>
@/home/jratz/.claude/get-shit-done/workflows/execute-plan.md
@/home/jratz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-wordpress-ai-discovery-plugin/04-RESEARCH.md
@.planning/phases/04-wordpress-ai-discovery-plugin/04-01-SUMMARY.md

<interfaces>
<!-- From Plan 01 — Parkk_Robots_Manager static method for UA list reuse: -->
```php
class Parkk_Robots_Manager {
    public static function get_ai_user_agents(): array {
        return [
            'GPTBot', 'ChatGPT-User', 'OAI-SearchBot',
            'ClaudeBot', 'Claude-User', 'Claude-SearchBot', 'anthropic-ai',
            'PerplexityBot', 'Perplexity-User',
            'Google-Extended', 'Gemini-Deep-Research', 'Google-CloudVertexBot',
            'cohere-ai', 'Amazonbot', 'DuckAssistBot', 'Meta-ExternalAgent',
        ];
    }
}
```

<!-- league/html-to-markdown usage pattern: -->
```php
use League\HTMLToMarkdown\HtmlConverter;
$converter = new HtmlConverter(['strip_tags' => true]);
$markdown = $converter->convert($html);
```

<!-- Parkk identity block (from research, derived from brand-voice.js): -->
```
---

**Parkk Technology** — Custom Software Development, AI Integration, and Equity Partnerships

- Custom Software Development: We build the software your business actually needs — scoped, shipped, supported.
- AI Integration for Existing Businesses: Add AI capabilities to what you already have — without rebuilding everything.
- Equity Partnership: We build for equity — no cash down. Serious builds for serious founders.

Contact: https://parkktech.com/contact | Author: Jason Park, founder of Parkk Technology
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install league/html-to-markdown as vendored dependency</name>
  <files>wordpress-plugin/parkk-ai-discovery/vendor/</files>
  <action>
Install `league/html-to-markdown` into the plugin's vendor directory using Composer:

1. Create `wordpress-plugin/parkk-ai-discovery/composer.json`:
   ```json
   {
       "name": "parkk/ai-discovery",
       "description": "Parkk AI Discovery WordPress Plugin",
       "require": {
           "league/html-to-markdown": "^5.1"
       },
       "config": {
           "vendor-dir": "vendor"
       }
   }
   ```

2. Run `cd wordpress-plugin/parkk-ai-discovery && composer install --no-dev --optimize-autoloader` to install the library.

3. Verify `vendor/autoload.php` exists and `vendor/league/html-to-markdown/` directory is populated.

4. The vendor directory will be committed to the repo (this is standard for WordPress plugins that bundle dependencies — no Composer on production hosting).

Do NOT namespace-prefix the library (PHP-Scoper or Mozart). The research recommended it but for a single-site plugin with no other plugins using this library, it's unnecessary complexity. If conflicts arise later, prefixing can be added as a patch.
  </action>
  <verify>
    <automated>test -f wordpress-plugin/parkk-ai-discovery/vendor/autoload.php && php -r "require 'wordpress-plugin/parkk-ai-discovery/vendor/autoload.php'; echo class_exists('League\HTMLToMarkdown\HtmlConverter') ? 'OK' : 'FAIL';"</automated>
  </verify>
  <done>vendor/autoload.php exists and loading it makes `League\HTMLToMarkdown\HtmlConverter` class available</done>
</task>

<task type="auto">
  <name>Task 2: Create AI responder class with UA detection, markdown serving, and identity block</name>
  <files>wordpress-plugin/parkk-ai-discovery/includes/class-ai-responder.php</files>
  <action>
Create `wordpress-plugin/parkk-ai-discovery/includes/class-ai-responder.php` with class `Parkk_AI_Responder`:

1. **ABSPATH guard** at top.

2. **`use` statement:** `use League\HTMLToMarkdown\HtmlConverter;`

3. **Constructor:** Hooks `maybe_serve_markdown` to `template_redirect` action.

4. **`is_ai_user_agent()` private method:**
   - Gets `$_SERVER['HTTP_USER_AGENT']` (default empty string if not set).
   - Calls `Parkk_Robots_Manager::get_ai_user_agents()` to get the canonical list (reuse, not duplicate).
   - Loops through list using `stripos()` for case-insensitive matching.
   - Returns `true` if any match found, `false` otherwise.

5. **`wants_markdown()` private method:**
   - Checks if `$_SERVER['HTTP_ACCEPT']` contains `text/markdown`.
   - Returns `true` if found, `false` otherwise.

6. **`maybe_serve_markdown()` public method** (the `template_redirect` callback):
   - Guard: `if ( ! is_singular( 'post' ) ) { return; }` — only intercept single blog posts, not pages, archives, or homepage.
   - Guard: `if ( ! $this->is_ai_user_agent() && ! $this->wants_markdown() ) { return; }` — only serve markdown to AI bots or explicit markdown requests.
   - Get the global `$post` object.
   - Get rendered content: `$html = apply_filters( 'the_content', $post->post_content );` — this runs the full WordPress content pipeline (shortcode expansion, Gutenberg block rendering) before conversion. This avoids Pitfall 3 from research (Gutenberg block HTML comments in output).
   - Convert to markdown using `league/html-to-markdown`:
     ```php
     $converter = new HtmlConverter([
         'strip_tags'                => true,
         'remove_nodes'              => 'script style',
         'hard_break'                => true,
         'strip_placeholder_links'   => true,
     ]);
     $markdown = $converter->convert( $html );
     ```
   - Build the full markdown response:
     ```
     # {post title}

     *Published: {post date} | Author: {post author display name}*

     {converted markdown content}

     {identity block}
     ```
   - Use `get_the_title( $post )`, `get_the_date( 'Y-m-d', $post )`, `get_the_author_meta( 'display_name', $post->post_author )`.
   - Call `$this->get_identity_block()` for the footer.
   - Set response headers:
     - `Content-Type: text/markdown; charset=UTF-8`
     - `Content-Signal: ai-train=yes, search=yes, ai-input=yes`
     - `X-Markdown-Tokens: {approximate token count}` — calculate as `(int) ( strlen( $full_markdown ) / 4 )` per research recommendation (rough chars-to-tokens approximation, same as Cloudflare).
     - `Vary: Accept, User-Agent` — ensures CDN/proxy caching differentiates HTML vs markdown responses.
     - `X-Content-Type-Options: nosniff`
   - Echo the full markdown string.
   - Call `exit;` to prevent WordPress from rendering the HTML template.

7. **`get_identity_block()` private method:**
   Returns this exact string (consistent brand footer per locked decision "Same block on every post"):
   ```
   \n\n---\n\n**Parkk Technology** — Custom Software Development, AI Integration, and Equity Partnerships\n\n- Custom Software Development: We build the software your business actually needs — scoped, shipped, supported.\n- AI Integration for Existing Businesses: Add AI capabilities to what you already have — without rebuilding everything.\n- Equity Partnership: We build for equity — no cash down. Serious builds for serious founders.\n\nContact: https://parkktech.com/contact | Author: Jason Park, founder of Parkk Technology\n
   ```
   Use PHP heredoc or concatenation — make sure newlines render as actual newlines in the output, not literal `\n`.
  </action>
  <verify>
    <automated>php -l wordpress-plugin/parkk-ai-discovery/includes/class-ai-responder.php</automated>
  </verify>
  <done>class-ai-responder.php passes PHP lint. Class hooks into template_redirect, detects AI UAs via Parkk_Robots_Manager::get_ai_user_agents(), converts HTML to markdown via league/html-to-markdown, appends identity block, sends Content-Signal + X-Markdown-Tokens + Vary headers, and exits.</done>
</task>

</tasks>

<verification>
1. `php -l` passes on class-ai-responder.php
2. vendor/autoload.php exists and loads HtmlConverter class
3. AI responder class reuses `Parkk_Robots_Manager::get_ai_user_agents()` (not a duplicated list)
4. Markdown response includes post title as H1, published date, author, converted content, and identity block
5. Headers include Content-Type: text/markdown, Content-Signal, X-Markdown-Tokens, Vary
6. Only singular posts are intercepted (not pages, archives, or homepage)
7. Identity block text matches the Parkk brand identity exactly
</verification>

<success_criteria>
- AI bots hitting a single post URL get markdown with Parkk identity block and Content-Signal headers
- Non-AI visitors are completely unaffected (guard returns early)
- league/html-to-markdown is installed and functional in vendor/
- WordPress content pipeline runs before conversion (apply_filters 'the_content') to avoid Gutenberg artifacts
</success_criteria>

<output>
After completion, create `.planning/phases/04-wordpress-ai-discovery-plugin/04-02-SUMMARY.md`
</output>
