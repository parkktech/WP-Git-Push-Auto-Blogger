---
phase: 04-wordpress-ai-discovery-plugin
plan: 04
type: execute
wave: 3
depends_on: [04-02]
files_modified:
  - wordpress-plugin/parkk-ai-discovery/includes/class-llms-endpoints.php
autonomous: true
requirements: [PLUG-05, PLUG-06]

must_haves:
  truths:
    - "/llms.txt returns a markdown directory with Parkk Technology company info, services section, and blog post index"
    - "/llms-full.txt returns full markdown content of up to 50 most recent published posts"
    - "llms-full.txt content is cached in a WordPress transient with 1-hour TTL and busted on save_post"
    - "Both endpoints return Content-Type: text/markdown and work regardless of visitor type"
  artifacts:
    - path: "wordpress-plugin/parkk-ai-discovery/includes/class-llms-endpoints.php"
      provides: "/llms.txt and /llms-full.txt virtual endpoints via WordPress rewrite rules"
      contains: "add_rewrite_rule"
  key_links:
    - from: "wordpress-plugin/parkk-ai-discovery/includes/class-llms-endpoints.php"
      to: "wordpress-plugin/parkk-ai-discovery/parkk-ai-discovery.php"
      via: "flush_rewrite_rules called on plugin activation"
      pattern: "flush_rewrite_rules"
    - from: "wordpress-plugin/parkk-ai-discovery/includes/class-llms-endpoints.php"
      to: "league/html-to-markdown HtmlConverter"
      via: "HTML-to-markdown conversion for llms-full.txt post content"
      pattern: "HtmlConverter"
---

<objective>
Create the /llms.txt and /llms-full.txt endpoints that serve markdown directories of Parkk Technology content for AI discovery.

Purpose: llms.txt is the emerging standard for AI discovery (like robots.txt for AI models). /llms.txt provides a lightweight company overview + blog post index. /llms-full.txt provides complete markdown content of the 50 most recent posts. This enables AI models to ingest the full site content efficiently.

Output: `class-llms-endpoints.php` with WordPress rewrite rules and content generation.
</objective>

<execution_context>
@/home/jratz/.claude/get-shit-done/workflows/execute-plan.md
@/home/jratz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-wordpress-ai-discovery-plugin/04-RESEARCH.md
@.planning/phases/04-wordpress-ai-discovery-plugin/04-02-SUMMARY.md

<interfaces>
<!-- From Plan 01 — Activation hook already calls flush_rewrite_rules(): -->
```php
function parkk_ai_discovery_activate() {
    flush_rewrite_rules();
}
register_activation_hook( __FILE__, 'parkk_ai_discovery_activate' );
```

<!-- From Plan 02 — league/html-to-markdown is vendored and autoloaded: -->
```php
use League\HTMLToMarkdown\HtmlConverter;
$converter = new HtmlConverter(['strip_tags' => true]);
$markdown = $converter->convert($html);
```

<!-- llms.txt spec structure (from llmstxt.org via research): -->
# H1 — Required: Company/site name
> Blockquote — Optional: Short description
Description paragraph — Optional
## H2 sections — Optional: Categorized content
- [Link Title](URL): Description
## Optional
- [Link Title](URL): Additional resources

<!-- Transient caching pattern from research: -->
Cache key: 'parkk_llms_full_txt'
TTL: HOUR_IN_SECONDS (3600)
Bust on: save_post action
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create llms.txt and llms-full.txt endpoint class with rewrite rules and transient caching</name>
  <files>wordpress-plugin/parkk-ai-discovery/includes/class-llms-endpoints.php</files>
  <action>
Create `wordpress-plugin/parkk-ai-discovery/includes/class-llms-endpoints.php` with class `Parkk_LLMS_Endpoints`:

1. **ABSPATH guard** at top.

2. **`use` statement:** `use League\HTMLToMarkdown\HtmlConverter;`

3. **Constructor:** Hooks three things:
   - `register_rewrite_rules` to `init` action
   - `handle_request` to `template_redirect` action
   - `bust_cache` to `save_post` action

4. **`register_rewrite_rules()` public method:**
   ```php
   add_rewrite_rule( '^llms\.txt$', 'index.php?parkk_llms=1', 'top' );
   add_rewrite_rule( '^llms-full\.txt$', 'index.php?parkk_llms_full=1', 'top' );
   ```
   Also register the query vars:
   ```php
   add_filter( 'query_vars', function( $vars ) {
       $vars[] = 'parkk_llms';
       $vars[] = 'parkk_llms_full';
       return $vars;
   } );
   ```
   NOTE: The query_vars filter MUST be registered (not just add_rewrite_tag) for WordPress to recognize the custom query vars. Use `add_filter` inside this method, not a separate hook.

5. **`handle_request()` public method** (template_redirect callback):
   ```php
   if ( get_query_var( 'parkk_llms' ) ) {
       $this->serve_llms_txt();
       exit;
   }
   if ( get_query_var( 'parkk_llms_full' ) ) {
       $this->serve_llms_full_txt();
       exit;
   }
   ```

6. **`serve_llms_txt()` private method:**
   Set headers:
   - `Content-Type: text/markdown; charset=UTF-8`
   - `X-Robots-Tag: noindex` (llms.txt is for AI, not search engine indexing)

   Generate the llms.txt content following the llmstxt.org spec structure:

   ```
   # Parkk Technology

   > Parkk Technology builds custom software and AI integrations for businesses. Founder: Jason Park. Contact: https://parkktech.com/contact

   Parkk Technology helps businesses ship custom software, AI integrations, and equity-based builds. We lead with outcomes, not technology — every project is scoped around measurable business impact.

   ## Services

   - Custom Software Development: We build the software your business actually needs — scoped, shipped, supported.
   - AI Integration for Existing Businesses: Add AI capabilities to what you already have — without rebuilding everything.
   - Equity Partnership: We build for equity — no cash down. Serious builds for serious founders.

   ## Blog Posts

   {dynamically generated from WP_Query}

   ## Optional

   - [Full Blog Content](/llms-full.txt): Complete markdown content of 50 most recent posts
   ```

   For the Blog Posts section, query published posts:
   ```php
   $posts = new WP_Query( [
       'post_type'      => 'post',
       'post_status'    => 'publish',
       'posts_per_page' => 50,
       'orderby'        => 'date',
       'order'          => 'DESC',
   ] );
   ```
   For each post: `- [{title}]({permalink}): {excerpt or first 30 words of content}`
   Use `get_the_excerpt()` first, fall back to `wp_trim_words( get_the_content(), 30 )`.
   Call `wp_reset_postdata()` after the loop.

   Echo the assembled string.

7. **`serve_llms_full_txt()` private method:**
   Set headers: same as llms.txt (`Content-Type: text/markdown`, `X-Robots-Tag: noindex`).

   Check transient cache first:
   ```php
   $cached = get_transient( 'parkk_llms_full_txt' );
   if ( false !== $cached ) {
       echo $cached;
       return;
   }
   ```

   If no cache, generate full content:
   - Same WP_Query as llms.txt (50 most recent published posts).
   - Header: `# Parkk Technology — Full Blog Content\n\n`
   - For each post:
     ```
     ## {post title}

     *Published: {date} | Author: {author} | URL: {permalink}*

     {full post content converted to markdown via HtmlConverter}

     ---

     ```
   - Convert each post's content: `apply_filters( 'the_content', $post->post_content )` then `$converter->convert( $html )`.
   - Use the same HtmlConverter options as class-ai-responder.php: `['strip_tags' => true, 'remove_nodes' => 'script style', 'hard_break' => true, 'strip_placeholder_links' => true]`.
   - Call `wp_reset_postdata()` after the loop.

   Store in transient:
   ```php
   set_transient( 'parkk_llms_full_txt', $content, HOUR_IN_SECONDS );
   ```

   Echo the content.

8. **`bust_cache()` public method** (save_post callback):
   ```php
   public function bust_cache( $post_id ) {
       if ( wp_is_post_revision( $post_id ) || wp_is_post_autosave( $post_id ) ) {
           return;
       }
       delete_transient( 'parkk_llms_full_txt' );
   }
   ```
   Only bust on real saves, not revisions or autosaves.

IMPORTANT: The `flush_rewrite_rules()` call is already in the plugin activation hook (created in Plan 01). Do NOT call flush_rewrite_rules() inside this class — it's a database write that should only happen on activation/deactivation.
  </action>
  <verify>
    <automated>php -l wordpress-plugin/parkk-ai-discovery/includes/class-llms-endpoints.php</automated>
  </verify>
  <done>class-llms-endpoints.php passes PHP lint. Registers rewrite rules for /llms.txt and /llms-full.txt. llms.txt generates company info + blog post index. llms-full.txt generates full markdown content of 50 most recent posts with transient caching (1hr TTL, busted on save_post). Both endpoints set Content-Type: text/markdown header.</done>
</task>

</tasks>

<verification>
1. `php -l` passes on class-llms-endpoints.php
2. Class registers two rewrite rules: `^llms\.txt$` and `^llms-full\.txt$`
3. Class registers `parkk_llms` and `parkk_llms_full` as query vars
4. llms.txt output follows llmstxt.org spec: H1, blockquote, description, ## sections
5. llms.txt includes dynamic blog post index from WP_Query (50 most recent)
6. llms-full.txt uses HtmlConverter for HTML-to-markdown conversion
7. llms-full.txt result is cached in transient `parkk_llms_full_txt` with HOUR_IN_SECONDS TTL
8. Transient is deleted on `save_post` (excluding revisions and autosaves)
</verification>

<success_criteria>
- /llms.txt returns Parkk Technology company info, services, and blog post index as markdown
- /llms-full.txt returns full markdown content of 50 most recent posts
- llms-full.txt is cached in a WordPress transient (1hr TTL) and busted when posts are saved
- Both endpoints respond regardless of visitor type (not AI-only — llms.txt is a public directory)
</success_criteria>

<output>
After completion, create `.planning/phases/04-wordpress-ai-discovery-plugin/04-04-SUMMARY.md`
</output>
