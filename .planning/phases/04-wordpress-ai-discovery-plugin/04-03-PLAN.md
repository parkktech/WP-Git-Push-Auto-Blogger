---
phase: 04-wordpress-ai-discovery-plugin
plan: 03
type: execute
wave: 2
depends_on: [04-01]
files_modified:
  - wordpress-plugin/parkk-ai-discovery/includes/class-schema-injector.php
autonomous: true
requirements: [PLUG-08, SCHM-03, SCHM-04, SCHM-05]

must_haves:
  truths:
    - "Homepage HTML source contains ProfessionalService + Organization + WebSite JSON-LD schemas in a single @graph"
    - "Single post HTML source contains Speakable schema targeting post title and first paragraph"
    - "Single post HTML source contains a structured summary JSON-LD block (Article with abstract)"
    - "Schema injection is skipped entirely if Yoast (WPSEO_VERSION) or RankMath (RankMath class) is detected active"
  artifacts:
    - path: "wordpress-plugin/parkk-ai-discovery/includes/class-schema-injector.php"
      provides: "JSON-LD schema injection via wp_head for Organization, ProfessionalService, WebSite, Speakable, and structured summary"
      contains: "wp_head"
  key_links:
    - from: "wordpress-plugin/parkk-ai-discovery/includes/class-schema-injector.php"
      to: "wp_head action"
      via: "add_action wp_head callback"
      pattern: "add_action.*wp_head"
---

<objective>
Create the sitewide schema injector: ProfessionalService + Organization + WebSite schema on the homepage, Speakable schema on single posts, and structured summary JSON-LD on single posts.

Purpose: Rich schema markup enables Google Rich Results (ProfessionalService, Organization), AI voice assistant eligibility (Speakable), and AI model context (structured summary via JSON-LD per PLUG-08 — NOT CSS-hidden blocks, which are a cloaking violation per locked decision).

Output: `class-schema-injector.php` with conditional JSON-LD injection via `wp_head`.
</objective>

<execution_context>
@/home/jratz/.claude/get-shit-done/workflows/execute-plan.md
@/home/jratz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-wordpress-ai-discovery-plugin/04-RESEARCH.md

<interfaces>
<!-- Brand identity data for schema fields (from scripts/brand-voice.js): -->
Company: Parkk Technology
Description: Custom software development, AI integration, and equity partnerships.
URL: https://parkktech.com
Contact: https://parkktech.com/contact
Founder: Jason Park
Services:
  - Custom Software Development
  - AI Integration for Existing Businesses
  - Equity Partnership
Area Served: US
Price Range: $25,000 - $150,000

<!-- Schema patterns from research: -->
- Organization + ProfessionalService + WebSite in a single @graph on homepage
- Speakable on singular posts with cssSelector targeting
- All output via wp_json_encode() for safe HTML context
- Guard against Yoast (defined('WPSEO_VERSION')) and RankMath (class_exists('RankMath'))

<!-- Elementor selector concern from research Open Questions: -->
parkktech.com uses Elementor. Standard WordPress classes (.entry-title, .entry-content) may not exist.
Fallback selectors: 'h1', 'article p:first-of-type' as universal alternatives.
Use BOTH sets: standard WordPress classes + universal fallbacks in cssSelector array.
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create schema injector class with sitewide and per-post JSON-LD</name>
  <files>wordpress-plugin/parkk-ai-discovery/includes/class-schema-injector.php</files>
  <action>
Create `wordpress-plugin/parkk-ai-discovery/includes/class-schema-injector.php` with class `Parkk_Schema_Injector`:

1. **ABSPATH guard** at top.

2. **Constructor:** Hooks two methods to `wp_head`:
   - `inject_sitewide_schema` (for homepage Organization + ProfessionalService + WebSite)
   - `inject_post_schema` (for single posts: Speakable + structured summary)

3. **`should_inject()` private method** — SEO plugin deduplication guard:
   ```php
   private function should_inject(): bool {
       // Skip if Yoast SEO is active (outputs its own Organization/WebSite schema)
       if ( defined( 'WPSEO_VERSION' ) ) {
           return false;
       }
       // Skip if RankMath is active
       if ( class_exists( 'RankMath' ) ) {
           return false;
       }
       return true;
   }
   ```
   Per research: Live audit confirms no SEO plugin currently active on parkktech.com, but this guard protects against future activation.

4. **`inject_sitewide_schema()` public method:**
   - Guard: `if ( ! $this->should_inject() ) { return; }`
   - Guard: `if ( ! is_front_page() ) { return; }` — homepage only.
   - Build a single `@graph` array containing 3 schema objects:

   **Organization:**
   ```php
   [
       '@type'        => 'Organization',
       '@id'          => home_url( '/#organization' ),
       'name'         => 'Parkk Technology',
       'url'          => home_url( '/' ),
       'description'  => 'Custom software development, AI integration, and equity partnerships.',
       'founder'      => [
           '@type' => 'Person',
           'name'  => 'Jason Park',
       ],
       'contactPoint' => [
           '@type'       => 'ContactPoint',
           'contactType' => 'customer service',
           'url'         => 'https://parkktech.com/contact',
       ],
   ]
   ```

   **ProfessionalService:**
   ```php
   [
       '@type'            => 'ProfessionalService',
       '@id'              => home_url( '/#professional-service' ),
       'name'             => 'Parkk Technology',
       'url'              => home_url( '/' ),
       'description'      => 'Custom software development, AI integration, and equity partnerships.',
       'areaServed'       => 'US',
       'priceRange'       => '$25,000 - $150,000',
       'parentOrganization' => [ '@id' => home_url( '/#organization' ) ],
       'hasOfferCatalog'  => [
           '@type'            => 'OfferCatalog',
           'name'             => 'Software Development Services',
           'itemListElement'  => [
               [
                   '@type'       => 'Offer',
                   'itemOffered' => [
                       '@type'       => 'Service',
                       'name'        => 'Custom Software Development',
                       'description' => 'We build the software your business actually needs — scoped, shipped, supported.',
                   ],
               ],
               [
                   '@type'       => 'Offer',
                   'itemOffered' => [
                       '@type'       => 'Service',
                       'name'        => 'AI Integration for Existing Businesses',
                       'description' => 'Add AI capabilities to what you already have — without rebuilding everything.',
                   ],
               ],
               [
                   '@type'       => 'Offer',
                   'itemOffered' => [
                       '@type'       => 'Service',
                       'name'        => 'Equity Partnership',
                       'description' => 'We build for equity — no cash down. Serious builds for serious founders.',
                   ],
               ],
           ],
       ],
   ]
   ```

   **WebSite (SCHM-05):**
   ```php
   [
       '@type'           => 'WebSite',
       '@id'             => home_url( '/#website' ),
       'url'             => home_url( '/' ),
       'name'            => 'Parkk Technology',
       'publisher'       => [ '@id' => home_url( '/#organization' ) ],
       'potentialAction' => [
           '@type'       => 'SearchAction',
           'target'      => [
               '@type'       => 'EntryPoint',
               'urlTemplate' => home_url( '/?s={search_term_string}' ),
           ],
           'query-input' => 'required name=search_term_string',
       ],
   ]
   ```

   Wrap in `@context` = `https://schema.org` and `@graph` array. Output via:
   ```php
   echo '<script type="application/ld+json">' .
        wp_json_encode( $schema, JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES ) .
        '</script>' . "\n";
   ```

5. **`inject_post_schema()` public method:**
   - Guard: `if ( ! is_singular( 'post' ) ) { return; }`
   - NOTE: Do NOT call `should_inject()` here — Speakable and structured summaries are unique to this plugin (Yoast/RankMath don't output them), so they should always be injected on posts.

   **Speakable schema (SCHM-04):**
   ```php
   $speakable = [
       '@context'  => 'https://schema.org',
       '@type'     => 'Article',
       'url'       => get_permalink(),
       'speakable' => [
           '@type'       => 'SpeakableSpecification',
           'cssSelector' => [
               '.entry-title',
               'h1',
               '.entry-content p:first-of-type',
               'article p:first-of-type',
           ],
       ],
   ];
   ```
   Include both standard WordPress selectors AND universal fallbacks (h1, article p:first-of-type) per Elementor compatibility concern from research.

   **Structured summary (PLUG-08):**
   Generate an abstract from the post content:
   ```php
   global $post;
   $content  = wp_strip_all_tags( apply_filters( 'the_content', $post->post_content ) );
   $abstract = wp_trim_words( $content, 50, '...' );

   $summary = [
       '@context'  => 'https://schema.org',
       '@type'     => 'Article',
       'headline'  => get_the_title(),
       'url'       => get_permalink(),
       'abstract'  => $abstract,
       'author'    => [
           '@type' => 'Person',
           'name'  => get_the_author_meta( 'display_name', $post->post_author ),
       ],
       'publisher' => [
           '@type' => 'Organization',
           'name'  => 'Parkk Technology',
           'url'   => home_url( '/' ),
       ],
       'datePublished' => get_the_date( 'c' ),
       'dateModified'  => get_the_modified_date( 'c' ),
   ];
   ```

   Output both as separate `<script type="application/ld+json">` blocks using `wp_json_encode()`.

   CRITICAL: Do NOT use CSS-hidden blocks for the structured summary. This is a locked decision — Google treats CSS-hidden content as a cloaking violation. JSON-LD is the correct approach (PLUG-08).
  </action>
  <verify>
    <automated>php -l wordpress-plugin/parkk-ai-discovery/includes/class-schema-injector.php</automated>
  </verify>
  <done>class-schema-injector.php passes PHP lint. Homepage gets Organization + ProfessionalService + WebSite @graph. Single posts get Speakable + Article/abstract JSON-LD blocks. SEO plugin guard prevents Organization/ProfessionalService/WebSite duplication if Yoast/RankMath is later activated. No CSS-hidden content anywhere.</done>
</task>

</tasks>

<verification>
1. `php -l` passes on class-schema-injector.php
2. Homepage schema includes @graph with Organization, ProfessionalService, and WebSite types
3. ProfessionalService includes hasOfferCatalog with 3 services matching brand-voice.js
4. WebSite schema includes SearchAction with urlTemplate
5. Single post schema includes Speakable with both standard and fallback CSS selectors
6. Single post schema includes Article with abstract (50-word excerpt from content)
7. SEO plugin guard checks for WPSEO_VERSION and RankMath class before homepage schema
8. All JSON-LD output uses wp_json_encode with JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES flags
</verification>

<success_criteria>
- Homepage source contains valid ProfessionalService + Organization + WebSite JSON-LD that would pass Google Rich Results Test
- Single post source contains Speakable JSON-LD and Article with abstract JSON-LD
- Schema is never CSS-hidden (JSON-LD only)
- Schema injection is skipped when Yoast or RankMath is active (deduplication guard)
</success_criteria>

<output>
After completion, create `.planning/phases/04-wordpress-ai-discovery-plugin/04-03-SUMMARY.md`
</output>
