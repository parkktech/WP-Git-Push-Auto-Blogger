---
phase: 03-thought-leadership-and-automation
plan: 02
type: execute
wave: 2
depends_on:
  - 03-01
files_modified:
  - .github/workflows/blog-post.yml
  - .github/workflows/thought-leadership.yml
autonomous: true
requirements:
  - ACTN-01
  - ACTN-02
  - ACTN-03
  - ACTN-04

user_setup:
  - service: github-secrets
    why: "GitHub Actions workflows need secrets and variables configured in the repository settings"
    env_vars:
      - name: ANTHROPIC_API_KEY
        source: "Anthropic Console -> API Keys"
      - name: WP_API_URL
        source: "WordPress site URL + /wp-json (e.g., https://parkktech.com/wp-json)"
      - name: WP_USER
        source: "WordPress admin username"
      - name: WP_APP_PASSWORD
        source: "WordPress -> Users -> Application Passwords"
      - name: TELEGRAM_BOT_TOKEN
        source: "Telegram BotFather"
      - name: TELEGRAM_CHAT_ID
        source: "Telegram chat ID"
      - name: UNSPLASH_ACCESS_KEY
        source: "Unsplash Developers -> Your Apps -> Access Key"
    dashboard_config:
      - task: "Create repository secrets"
        location: "GitHub -> repo -> Settings -> Secrets and variables -> Actions -> Secrets"
      - task: "Create repository variables: PROJECT_NAME, PROJECT_URL, PROJECT_DESCRIPTION, SCREENSHOT_URLS, MIN_WORTHINESS_SCORE, PUBLISH_STATUS, WORDPRESS_SEO_PLUGIN"
        location: "GitHub -> repo -> Settings -> Secrets and variables -> Actions -> Variables"

must_haves:
  truths:
    - "Pushing a commit to main triggers the blog-post workflow automatically"
    - "The thought leadership workflow fires on Monday 8am UTC cron schedule"
    - "Both workflows can be manually triggered via workflow_dispatch"
    - "Concurrent workflow runs are prevented by concurrency controls with cancel-in-progress"
    - "All secrets and variables are passed to the Node scripts as environment variables"
    - "Pushing a docs-only or workflow-only commit does not trigger the blog post workflow"
  artifacts:
    - path: ".github/workflows/blog-post.yml"
      provides: "Push-to-main blog post generation workflow"
      contains: "on:\n  push:\n    branches:\n      - main"
    - path: ".github/workflows/thought-leadership.yml"
      provides: "Weekly cron thought leadership workflow"
      contains: "cron: '0 8 * * 1'"
  key_links:
    - from: ".github/workflows/blog-post.yml"
      to: "scripts/generate-blog-post.js"
      via: "node scripts/generate-blog-post.js with env vars from secrets/vars"
      pattern: "node scripts/generate-blog-post\\.js"
    - from: ".github/workflows/thought-leadership.yml"
      to: "scripts/generate-thought-leadership.js"
      via: "node scripts/generate-thought-leadership.js with env vars from secrets/vars"
      pattern: "node scripts/generate-thought-leadership\\.js"
    - from: ".github/workflows/blog-post.yml"
      to: "GitHub concurrency"
      via: "concurrency group with cancel-in-progress"
      pattern: "cancel-in-progress: true"
    - from: ".github/workflows/thought-leadership.yml"
      to: "GitHub concurrency"
      via: "concurrency group with cancel-in-progress"
      pattern: "cancel-in-progress: true"
---

<objective>
Create both GitHub Actions workflow YAML files: `blog-post.yml` (push-to-main trigger for commit blog posts) and `thought-leadership.yml` (Monday 8am UTC cron for thought leadership posts). Both workflows wire secrets, variables, concurrency controls, and call the appropriate Node.js scripts from Phase 2 and Plan 03-01.

Purpose: Automate both content pipelines so commits and weekly thought leadership posts generate without manual script execution.
Output: `.github/workflows/blog-post.yml` and `.github/workflows/thought-leadership.yml`
</objective>

<execution_context>
@/home/jratz/.claude/get-shit-done/workflows/execute-plan.md
@/home/jratz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-thought-leadership-and-automation/03-RESEARCH.md
@.planning/phases/03-thought-leadership-and-automation/03-01-SUMMARY.md
@scripts/generate-blog-post.js
@scripts/generate-thought-leadership.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create blog-post.yml workflow with push trigger and commit data extraction</name>
  <files>.github/workflows/blog-post.yml</files>
  <action>
Create `.github/workflows/blog-post.yml` (create the `.github/workflows/` directory first if it does not exist).

**Workflow structure:**

```yaml
name: Blog Post Generator

on:
  push:
    branches:
      - main
    paths-ignore:
      - '.github/**'
      - '.planning/**'
      - '**.md'
      - 'wordpress-plugin/**'
  workflow_dispatch:
```

The `paths-ignore` block prevents self-triggering on documentation commits, workflow changes, and planning file changes. This is a Claude's Discretion area from CONTEXT.md — implement it to avoid unnecessary pipeline runs on non-code commits. The worthiness evaluator would catch these anyway (score below threshold), but skipping the workflow entirely saves CI minutes and API calls.

**Concurrency block** (workflow-level, before jobs):
```yaml
concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true
```

**Job: generate**
- `runs-on: ubuntu-latest`
- Job-level `env:` block mapping ALL secrets and vars (copy from 03-RESEARCH.md Pattern 2 exactly):
  - Secrets: ANTHROPIC_API_KEY, WP_API_URL, WP_USER, WP_APP_PASSWORD, TELEGRAM_BOT_TOKEN, TELEGRAM_CHAT_ID, UNSPLASH_ACCESS_KEY
  - Vars: PROJECT_NAME, PROJECT_URL, PROJECT_DESCRIPTION, SCREENSHOT_URLS, MIN_WORTHINESS_SCORE, PUBLISH_STATUS, WORDPRESS_SEO_PLUGIN

**Steps:**

1. **Checkout** with `actions/checkout@v4` and `fetch-depth: 2` (required for `git diff HEAD~1 HEAD`)

2. **Setup Node.js** with `actions/setup-node@v4` and `node-version: '22'`

3. **Install dependencies:** `npm ci` with `working-directory: scripts`

4. **Generate blog post** — single step that extracts commit data and runs the script:
```yaml
- name: Generate blog post
  run: |
    COMMIT_MESSAGE=$(git log -1 --pretty=format:'%s') \
    COMMIT_AUTHOR=$(git log -1 --pretty=format:'%ae') \
    COMMIT_DIFF=$(git diff HEAD~1 HEAD -- . ':!*.lock' ':!node_modules' ':!package-lock.json') \
    node scripts/generate-blog-post.js
```

This approach uses inline shell variable assignment rather than step outputs to avoid GitHub Actions' ~1MB output truncation for large diffs. Uses `git log` instead of `github.event.head_commit.message` because the latter is undefined on `workflow_dispatch` events.

**Key notes:**
- Do NOT use `set-env` or `save-state` (deprecated/removed)
- Do NOT use `github.event.head_commit.message` (undefined on workflow_dispatch)
- The pathspec `:!*.lock` and `:!node_modules` and `:!package-lock.json` in git diff prevents lock file noise from reaching Claude
  </action>
  <verify>
    <automated>cd /var/www/html/parkktec/parkk-blog-engine &amp;&amp; test -f .github/workflows/blog-post.yml &amp;&amp; node -e "
const fs = require('fs');
const yaml = fs.readFileSync('.github/workflows/blog-post.yml', 'utf8');
const checks = {
  pushTrigger: yaml.includes('push:') &amp;&amp; yaml.includes('branches:') &amp;&amp; yaml.includes('- main'),
  workflowDispatch: yaml.includes('workflow_dispatch'),
  concurrency: yaml.includes('cancel-in-progress: true'),
  fetchDepth: yaml.includes('fetch-depth: 2'),
  nodeSetup: yaml.includes('setup-node@v4') &amp;&amp; yaml.includes(\"node-version: '22'\"),
  npmCi: yaml.includes('npm ci'),
  generateScript: yaml.includes('generate-blog-post.js'),
  commitMessage: yaml.includes('git log -1'),
  commitDiff: yaml.includes('git diff HEAD~1 HEAD'),
  secrets: yaml.includes('ANTHROPIC_API_KEY') &amp;&amp; yaml.includes('WP_API_URL') &amp;&amp; yaml.includes('TELEGRAM_BOT_TOKEN'),
  vars: yaml.includes('PROJECT_NAME') &amp;&amp; yaml.includes('PUBLISH_STATUS'),
  pathsIgnore: yaml.includes('paths-ignore'),
};
Object.entries(checks).forEach(([k, v]) => console.log(k + ':', v));
const allPass = Object.values(checks).every(Boolean);
if (!allPass) process.exit(1);
console.log('ALL CHECKS PASSED');
"</automated>
  </verify>
  <done>
- .github/workflows/blog-post.yml exists with push-to-main trigger
- workflow_dispatch enabled for manual testing
- Concurrency group with cancel-in-progress prevents duplicate runs
- fetch-depth: 2 enables git diff
- All secrets and vars mapped as environment variables
- paths-ignore prevents triggering on docs/planning/workflow changes
- Commit data extracted via git log (not github.event context) for workflow_dispatch compatibility
  </done>
</task>

<task type="auto">
  <name>Task 2: Create thought-leadership.yml workflow with Monday cron trigger</name>
  <files>.github/workflows/thought-leadership.yml</files>
  <action>
Create `.github/workflows/thought-leadership.yml`.

**Workflow structure:**

```yaml
name: Thought Leadership Generator

on:
  schedule:
    - cron: '0 8 * * 1'   # Monday 8:00 AM UTC
  workflow_dispatch:
```

**Concurrency block** (workflow-level, before jobs):
```yaml
concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true
```

The concurrency group uses `${{ github.workflow }}` which resolves to "Thought Leadership Generator" — a different group from "Blog Post Generator", so the two workflows cannot cancel each other.

**Job: generate**
- `runs-on: ubuntu-latest`
- Job-level `env:` block mapping secrets and vars needed by the thought leadership script:
  - Secrets: ANTHROPIC_API_KEY, WP_API_URL, WP_USER, WP_APP_PASSWORD, TELEGRAM_BOT_TOKEN, TELEGRAM_CHAT_ID, UNSPLASH_ACCESS_KEY
  - Vars: PUBLISH_STATUS, WORDPRESS_SEO_PLUGIN
  - Note: PROJECT_NAME, PROJECT_URL, PROJECT_DESCRIPTION, SCREENSHOT_URLS, and MIN_WORTHINESS_SCORE are NOT needed for thought leadership (no commit context, no screenshots, no worthiness scoring)

**Steps:**

1. **Checkout** with `actions/checkout@v4` (NO `fetch-depth: 2` — thought leadership doesn't need git history)

2. **Setup Node.js** with `actions/setup-node@v4` and `node-version: '22'`

3. **Install dependencies:** `npm ci` with `working-directory: scripts`

4. **Generate thought leadership post:**
```yaml
- name: Generate thought leadership post
  run: node scripts/generate-thought-leadership.js
```

That's it — the script derives pillar/angle from the current date. No inputs needed.

**Key notes:**
- Do NOT add `fetch-depth: 2` (unnecessary — no commit diff needed)
- Do NOT include PROJECT_NAME, PROJECT_URL, PROJECT_DESCRIPTION, SCREENSHOT_URLS, MIN_WORTHINESS_SCORE (not used by thought leadership script)
- Cron syntax `0 8 * * 1` is verified: minute 0, hour 8, any day-of-month, any month, Monday
- GitHub cron may run up to 15-30 minutes late during high load — this is acceptable
- Add a YAML comment noting that `PUBLISH_STATUS` defaults to 'draft' if unset
  </action>
  <verify>
    <automated>cd /var/www/html/parkktec/parkk-blog-engine &amp;&amp; test -f .github/workflows/thought-leadership.yml &amp;&amp; node -e "
const fs = require('fs');
const yaml = fs.readFileSync('.github/workflows/thought-leadership.yml', 'utf8');
const checks = {
  cronTrigger: yaml.includes(\"cron: '0 8 * * 1'\"),
  workflowDispatch: yaml.includes('workflow_dispatch'),
  concurrency: yaml.includes('cancel-in-progress: true'),
  noFetchDepth: !yaml.includes('fetch-depth'),
  nodeSetup: yaml.includes('setup-node@v4') &amp;&amp; yaml.includes(\"node-version: '22'\"),
  npmCi: yaml.includes('npm ci'),
  generateScript: yaml.includes('generate-thought-leadership.js'),
  secrets: yaml.includes('ANTHROPIC_API_KEY') &amp;&amp; yaml.includes('WP_API_URL'),
  publishStatus: yaml.includes('PUBLISH_STATUS'),
};
Object.entries(checks).forEach(([k, v]) => console.log(k + ':', v));
const allPass = Object.values(checks).every(Boolean);
if (!allPass) process.exit(1);
console.log('ALL CHECKS PASSED');
"</automated>
  </verify>
  <done>
- .github/workflows/thought-leadership.yml exists with Monday 8am UTC cron trigger
- workflow_dispatch enabled for manual testing
- Concurrency group with cancel-in-progress prevents duplicate runs
- Only relevant secrets and vars mapped (no commit-specific variables)
- No fetch-depth: 2 (unnecessary for thought leadership)
- Script invocation is a simple `node scripts/generate-thought-leadership.js` with no inputs
  </done>
</task>

</tasks>

<verification>
1. `.github/workflows/blog-post.yml` exists with valid YAML structure
2. `.github/workflows/thought-leadership.yml` exists with valid YAML structure
3. Blog post workflow triggers on push to main with paths-ignore
4. Thought leadership workflow triggers on Monday 8am UTC cron
5. Both workflows support workflow_dispatch for manual testing
6. Both workflows have concurrency groups with cancel-in-progress: true
7. Blog post workflow extracts commit data via git log (not github.event context)
8. Blog post workflow uses fetch-depth: 2 for git diff
9. Thought leadership workflow does NOT have fetch-depth: 2
10. All required secrets mapped as env vars in both workflows
11. Vars mapped appropriately per workflow (blog-post gets more vars than thought-leadership)
</verification>

<success_criteria>
- Both workflow YAML files exist and are valid YAML
- Blog post workflow: push trigger + paths-ignore + workflow_dispatch + concurrency + fetch-depth: 2 + all env vars
- Thought leadership workflow: cron trigger + workflow_dispatch + concurrency + minimal env vars
- Both use actions/checkout@v4 and actions/setup-node@v4 with Node 22
- Concurrency groups isolated by workflow name
</success_criteria>

<output>
After completion, create `.planning/phases/03-thought-leadership-and-automation/03-02-SUMMARY.md`
</output>
