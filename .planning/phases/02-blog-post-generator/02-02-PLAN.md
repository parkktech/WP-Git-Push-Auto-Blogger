---
phase: 02-blog-post-generator
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/media-pipeline.js
autonomous: true
requirements:
  - PUBL-05
  - PUBL-08
  - PUBL-09

user_setup:
  - service: unsplash
    why: "Stock image search for blog post visuals"
    env_vars:
      - name: UNSPLASH_ACCESS_KEY
        source: "Unsplash Developer Portal -> Your Apps -> Access Key (https://unsplash.com/developers)"
    dashboard_config:
      - task: "Create an Unsplash app (Demo mode is fine for development; apply for Production before scaling)"
        location: "https://unsplash.com/oauth/applications/new"

must_haves:
  truths:
    - "captureScreenshots() launches Puppeteer with --no-sandbox, --disable-setuid-sandbox, --disable-dev-shm-usage flags and returns array of screenshot buffers"
    - "When SCREENSHOT_URLS is empty or not configured, captureScreenshots returns an empty array without error"
    - "When Puppeteer fails to launch or a page fails to load, the function returns whatever screenshots succeeded (graceful degradation)"
    - "searchUnsplash() calls Unsplash API with keyword, triggers download_location endpoint for each photo, and returns image buffers with attribution HTML"
    - "Unsplash attribution HTML includes photographer name linked to their Unsplash profile with UTM parameters and Unsplash link with UTM parameters"
    - "When UNSPLASH_ACCESS_KEY is not set, searchUnsplash returns an empty array without error"
  artifacts:
    - path: "scripts/media-pipeline.js"
      provides: "Screenshot capture and stock image download functions"
      exports: ["captureScreenshots", "searchUnsplash"]
  key_links:
    - from: "scripts/media-pipeline.js"
      to: "puppeteer"
      via: "require('puppeteer') for screenshot capture"
      pattern: "require\\('puppeteer'\\)"
    - from: "scripts/media-pipeline.js"
      to: "Unsplash API"
      via: "native fetch() to api.unsplash.com"
      pattern: "api\\.unsplash\\.com"
    - from: "scripts/media-pipeline.js"
      to: "scripts/generate-blog-post.js (Plan 04)"
      via: "module.exports consumed by main orchestrator"
      pattern: "module\\.exports"
---

<objective>
Build the media pipeline module that captures screenshots via Puppeteer and downloads stock images from Unsplash.

Purpose: Screenshots and stock images are the visual assets for blog posts. This module handles all image acquisition — Puppeteer for staging URL screenshots and Unsplash for supplemental stock photos. Both are gracefully degrading: failures produce empty arrays, never pipeline crashes.

Output: `scripts/media-pipeline.js` exporting `captureScreenshots()` and `searchUnsplash()` functions.
</objective>

<execution_context>
@/home/jratz/.claude/get-shit-done/workflows/execute-plan.md
@/home/jratz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-blog-post-generator/02-RESEARCH.md
@scripts/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create media-pipeline.js with Puppeteer screenshot capture</name>
  <files>scripts/media-pipeline.js</files>
  <action>
Create `scripts/media-pipeline.js` as a CommonJS module.

**Screenshot capture function:**

```javascript
async function captureScreenshots(urls) { ... }
```

- If `urls` is falsy or empty array, return `[]` immediately (no Puppeteer launch)
- Launch Puppeteer with required CI flags: `{ headless: true, args: ['--no-sandbox', '--disable-setuid-sandbox', '--disable-dev-shm-usage', '--disable-gpu'] }`
- Set viewport: `{ width: 1280, height: 800 }`
- For each URL:
  - Open new page
  - Navigate with `waitUntil: 'networkidle0'` and `timeout: 30000`
  - Take screenshot: `page.screenshot({ type: 'png', fullPage: false })` — viewport capture (not full page by default; Claude's discretion per locked decision means we provide a reasonable default)
  - Push `{ buffer, url, mediaType: 'image/png' }` to results array
  - Close page
  - Wrap individual page navigation/screenshot in try/catch — log warning and continue to next URL on failure
- Wrap entire function body in try/catch — if Puppeteer fails to launch, log warning and return empty array
- Always close browser in `finally` block
- Return array of `{ buffer: Buffer, url: string, mediaType: string }`

Do NOT export searchUnsplash yet — that is Task 2. Export only `captureScreenshots` at the end of the file for now.
  </action>
  <verify>
    <automated>node -e "const m = require('./scripts/media-pipeline'); console.assert(typeof m.captureScreenshots === 'function'); m.captureScreenshots([]).then(r => { console.assert(Array.isArray(r)); console.assert(r.length === 0); console.log('Screenshot function: empty input returns empty array'); }).catch(e => console.error(e))"</automated>
    <manual>Review that Puppeteer launch args include all 4 required flags and that try/catch wraps both the launch and individual page operations</manual>
  </verify>
  <done>captureScreenshots function exported. Returns empty array for null/empty input. Puppeteer launched with --no-sandbox, --disable-setuid-sandbox, --disable-dev-shm-usage, --disable-gpu. Individual URL failures don't crash the batch. Browser always closed in finally block.</done>
</task>

<task type="auto">
  <name>Task 2: Add Unsplash stock image search with download tracking and attribution</name>
  <files>scripts/media-pipeline.js</files>
  <action>
Add `searchUnsplash()` function to the existing `scripts/media-pipeline.js`.

**Unsplash search function:**

```javascript
async function searchUnsplash(keyword, count = 3) { ... }
```

- Read `UNSPLASH_ACCESS_KEY` from `process.env`
- If key is not set, log `'Unsplash not configured — skipping stock images'` and return `[]`
- Call Unsplash search API:
  ```
  GET https://api.unsplash.com/search/photos?query={keyword}&per_page={count}&orientation=landscape
  Authorization: Client-ID {ACCESS_KEY}
  ```
- For each photo in `data.results`:
  1. **Trigger download tracking** (REQUIRED by Unsplash guidelines): `GET photo.links.download_location` with same auth header. Wrap in try/catch — if tracking fails, still proceed with download.
  2. **Download image bytes**: `fetch(photo.urls.regular)` — the `regular` size is 1080px wide, optimal for blog posts
  3. **Build attribution HTML**: `Photo by <a href="${photo.user.links.html}?utm_source=parkk_blog&utm_medium=referral">${photo.user.name}</a> on <a href="https://unsplash.com/?utm_source=parkk_blog&utm_medium=referral">Unsplash</a>` — wrapped in `<p class="photo-credit">...</p>`
  4. Push `{ buffer: Buffer, mimeType: 'image/jpeg', filename: \`unsplash-${photo.id}.jpg\`, attribution: attributionHtml }` to results
- Wrap entire function in try/catch — log error and return empty array on any API failure (graceful degradation per locked decision: "When Puppeteer fails... gracefully fall back to stock images only" applies in reverse too — stock image failure should not crash)
- Return array of image objects

**Update module.exports** to include both `captureScreenshots` and `searchUnsplash`.

Use native `fetch()` throughout (Node 22 built-in — no axios or node-fetch per research recommendation).
  </action>
  <verify>
    <automated>node -e "const m = require('./scripts/media-pipeline'); console.assert(typeof m.searchUnsplash === 'function'); console.assert(typeof m.captureScreenshots === 'function'); console.log('Both media pipeline functions exported'); (async () => { const r = await m.searchUnsplash('test'); console.assert(Array.isArray(r)); console.log('searchUnsplash returns array (empty without UNSPLASH_ACCESS_KEY)'); })()"</automated>
    <manual>Review that download_location endpoint is called before downloading each image, and attribution HTML includes correct UTM parameters</manual>
  </verify>
  <done>searchUnsplash function exported alongside captureScreenshots. Returns empty array when UNSPLASH_ACCESS_KEY not set. Triggers download_location endpoint for each photo before downloading. Attribution HTML includes photographer credit with UTM-linked Unsplash URLs. Uses native fetch() throughout.</done>
</task>

</tasks>

<verification>
1. `require('./scripts/media-pipeline')` loads without error
2. `captureScreenshots([])` resolves to empty array
3. `searchUnsplash('test')` resolves to empty array when UNSPLASH_ACCESS_KEY is not set
4. Both functions handle errors gracefully (no unhandled promise rejections)
5. Puppeteer launch args include all 4 CI-required flags
6. Unsplash download_location endpoint is called before image download (visible in code)
7. Attribution HTML includes UTM parameters with utm_source=parkk_blog
</verification>

<success_criteria>
- `scripts/media-pipeline.js` exists and exports captureScreenshots and searchUnsplash
- captureScreenshots uses Puppeteer with correct CI flags and gracefully handles failures
- searchUnsplash triggers Unsplash download tracking endpoint before downloading
- searchUnsplash builds attribution HTML with photographer credit and UTM links
- Both functions return empty arrays on misconfiguration or failure (never throw)
- Uses native fetch() — no additional HTTP libraries
- Module follows CommonJS pattern established in Phase 1
</success_criteria>

<output>
After completion, create `.planning/phases/02-blog-post-generator/02-02-SUMMARY.md`
</output>
