---
phase: 02-blog-post-generator
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/evaluate-commit.js
autonomous: true
requirements:
  - PIPE-01
  - PIPE-02
  - PIPE-03
  - PIPE-04
  - PIPE-05
  - PIPE-06
  - PIPE-07
  - SCHM-01
  - SCHM-02

must_haves:
  truths:
    - "shouldSkipCommit() returns true for dependabot, chore:, ci:, [skip-blog], and merge commits"
    - "evaluateWorthiness() calls Claude API and returns a structured JSON with score 1-10, reasoning, and topic_summary"
    - "Commits scoring below 7 are identified as skippable by the returned score"
    - "generateBlogPost() calls Claude API with structured output and returns complete post JSON with title, slug, seoTitle, metaDescription, focusKeyword, htmlContent, categories, tags, answerFirstBlock, and schema fields"
    - "Generated post HTML includes BlogPosting JSON-LD script tag"
    - "Generated post HTML includes FAQPage JSON-LD script tag"
    - "Generated post includes answer-first block of 40-60 words"
    - "Brand voice module (BRAND, getUrgencyBlock, getRandomFAQs, getRandomCTA) is imported and injected into Claude system prompt"
  artifacts:
    - path: "scripts/evaluate-commit.js"
      provides: "Commit evaluation and blog post generation functions"
      exports: ["shouldSkipCommit", "evaluateWorthiness", "generateBlogPost", "WORTHINESS_THRESHOLD"]
  key_links:
    - from: "scripts/evaluate-commit.js"
      to: "scripts/brand-voice.js"
      via: "require('./brand-voice')"
      pattern: "require\\('./brand-voice'\\)"
    - from: "scripts/evaluate-commit.js"
      to: "@anthropic-ai/sdk"
      via: "new Anthropic() client for structured output calls"
      pattern: "new Anthropic"
    - from: "scripts/evaluate-commit.js"
      to: "scripts/generate-blog-post.js (Plan 04)"
      via: "module.exports consumed by main orchestrator"
      pattern: "module\\.exports"
---

<objective>
Build the content evaluation and generation module that handles all Claude API interactions for the blog post pipeline.

Purpose: This module is the intelligence layer — it decides which commits deserve blog posts (skip patterns + worthiness scoring) and generates the full post content (HTML, SEO meta, schema, FAQ) using Claude structured outputs. Separating this from the WordPress/media concerns keeps each module focused and testable.

Output: `scripts/evaluate-commit.js` exporting `shouldSkipCommit()`, `evaluateWorthiness()`, and `generateBlogPost()` functions.
</objective>

<execution_context>
@/home/jratz/.claude/get-shit-done/workflows/execute-plan.md
@/home/jratz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-blog-post-generator/02-RESEARCH.md
@scripts/brand-voice.js
@scripts/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create evaluate-commit.js with skip patterns and worthiness evaluation</name>
  <files>scripts/evaluate-commit.js</files>
  <action>
Create `scripts/evaluate-commit.js` as a CommonJS module (matching brand-voice.js pattern).

**Part A — Skip pattern function:**

```javascript
function shouldSkipCommit(commitMessage, authorLogin) { ... }
```

Returns `true` for:
- `authorLogin` containing 'dependabot' or 'dependabot[bot]'
- Commit message starting with 'Merge ' or 'Merge pull request'
- Conventional commit prefixes: `chore:`, `ci:`, `docs:`, `style:`, `test:`, `build:`, `revert:` (case-insensitive, with optional scope like `chore(deps):`)
- Commit message containing `[skip-blog]`

Use regex: `/^(chore|ci|docs|style|test|build|revert)(\(.+\))?:/i`

**Part B — Worthiness evaluation function:**

```javascript
const WORTHINESS_THRESHOLD = parseInt(process.env.MIN_WORTHINESS_SCORE || '7', 10);

async function evaluateWorthiness(commitMessage, diff) { ... }
```

- Initialize Anthropic client: `new Anthropic()` (reads ANTHROPIC_API_KEY from env automatically)
- Call `client.messages.create()` with:
  - `model: 'claude-sonnet-4-6'`
  - `max_tokens: 256`
  - System prompt: evaluator for a software development portfolio blog, scoring commits on how interesting/valuable they are for demonstrating technical capability to potential clients
  - User message: commit message + diff (per locked decision: diff + message only, no file list or project context)
  - `output_config.format` with `type: 'json_schema'` using the WORTHINESS_JSON_SCHEMA:
    ```javascript
    {
      type: 'object',
      properties: {
        score: { type: 'integer' },
        reasoning: { type: 'string' },
        topic_summary: { type: 'string' }
      },
      required: ['score', 'reasoning', 'topic_summary'],
      additionalProperties: false
    }
    ```
- Parse response: `JSON.parse(response.content[0].text)`
- Return the parsed object (caller checks `result.score >= WORTHINESS_THRESHOLD`)
- Log: `console.log(\`Worthiness: ${result.score}/10 — ${result.reasoning}\`)`

Export: `module.exports = { shouldSkipCommit, evaluateWorthiness, WORTHINESS_THRESHOLD }`

Do NOT add generateBlogPost yet — that is Task 2. End the file with the exports after these two functions plus WORTHINESS_THRESHOLD.
  </action>
  <verify>
    <automated>node -e "const m = require('./scripts/evaluate-commit'); console.assert(typeof m.shouldSkipCommit === 'function'); console.assert(typeof m.evaluateWorthiness === 'function'); console.assert(m.WORTHINESS_THRESHOLD === 7); console.assert(m.shouldSkipCommit('chore(deps): bump lodash', null) === true); console.assert(m.shouldSkipCommit('Merge pull request #42', null) === true); console.assert(m.shouldSkipCommit('feat: add dashboard', null) === false); console.assert(m.shouldSkipCommit('[skip-blog] minor tweak', null) === true); console.assert(m.shouldSkipCommit('fix: auth bug', 'dependabot[bot]') === true); console.log('All skip pattern assertions passed')"</automated>
    <manual>Verify shouldSkipCommit covers all 5 skip categories and evaluateWorthiness function signature looks correct</manual>
  </verify>
  <done>shouldSkipCommit correctly identifies all 5 skip categories (dependabot, merge, conventional-commit-noise, [skip-blog], author). evaluateWorthiness is exported and ready for Claude API calls. WORTHINESS_THRESHOLD defaults to 7.</done>
</task>

<task type="auto">
  <name>Task 2: Add blog post generation function with structured outputs and schema injection</name>
  <files>scripts/evaluate-commit.js</files>
  <action>
Add `generateBlogPost()` to the existing `scripts/evaluate-commit.js` file. This function calls Claude with structured outputs to produce the complete blog post JSON.

**Add the post JSON schema constant:**

```javascript
const POST_JSON_SCHEMA = {
  type: 'object',
  properties: {
    title: { type: 'string' },
    slug: { type: 'string' },
    seoTitle: { type: 'string' },
    metaDescription: { type: 'string' },
    focusKeyword: { type: 'string' },
    secondaryKeywords: { type: 'array', items: { type: 'string' } },
    excerpt: { type: 'string' },
    htmlContent: { type: 'string' },
    categories: { type: 'array', items: { type: 'string' } },
    tags: { type: 'array', items: { type: 'string' } },
    answerFirstBlock: { type: 'string' },
    faqItems: {
      type: 'array',
      items: {
        type: 'object',
        properties: {
          question: { type: 'string' },
          answer: { type: 'string' }
        },
        required: ['question', 'answer'],
        additionalProperties: false
      }
    },
    blogPostingSchema: { type: 'string' },
    faqPageSchema: { type: 'string' }
  },
  required: ['title', 'slug', 'seoTitle', 'metaDescription', 'focusKeyword',
             'excerpt', 'htmlContent', 'categories', 'tags', 'answerFirstBlock',
             'faqItems', 'blogPostingSchema', 'faqPageSchema'],
  additionalProperties: false
};
```

**Add the system prompt builder:**

```javascript
function buildSystemPrompt(brand, urgencyBlock, faqs, cta) { ... }
```

The system prompt must instruct Claude to:
- Write as a portfolio blog for Parkk Technology (use `brand.name`, `brand.author`, `brand.authorTitle`)
- Follow all `brand.voiceRules` — list them explicitly
- Describe services from `brand.services` array
- Frame every post as a portfolio piece demonstrating technical capability (PIPE-05: PROJECT_REGISTRY via env vars `PROJECT_NAME`, `PROJECT_URL`, `PROJECT_DESCRIPTION`)
- Include an answer-first block of exactly 40-60 words optimized for AI Overview snippets (PIPE-06)
- Generate FAQ items using the provided FAQ templates as inspiration — adapt questions/answers to the specific commit topic (PIPE-07)
- Use keyword-rich H2/H3 headings optimized for search queries (locked decision)
- Target 1500-2500 words (locked decision)
- No code snippets — pure outcomes and business value (locked decision)
- Include the urgency block text naturally in the post body
- End with the CTA block (heading, body, url, action)
- Generate BlogPosting JSON-LD as a complete `<script type="application/ld+json">` string with @type BlogPosting, headline, author (Person), publisher (Organization: Parkk Technology), datePublished (today ISO), keywords array (SCHM-01)
- Generate FAQPage JSON-LD as a complete `<script type="application/ld+json">` string with @type FAQPage and mainEntity array of Question/Answer pairs (SCHM-02)
- Generate 2-3 category slugs and 3-5 tag strings

**Add the generation function:**

```javascript
async function generateBlogPost(commitMessage, diff, evaluation, screenshotBuffers) { ... }
```

- Import brand-voice: `const { BRAND, getUrgencyBlock, getRandomFAQs, getRandomCTA } = require('./brand-voice')`
- Get brand content: urgency block, 3 random FAQs, 1 random CTA
- Build image content blocks from `screenshotBuffers` array (each item has `.buffer` and `.mediaType`). Send as base64 image blocks in the user message so Claude can see what was built.
- Call `client.messages.create()` with:
  - `model: 'claude-sonnet-4-6'`
  - `max_tokens: 8192`
  - System prompt from `buildSystemPrompt()`
  - User message: array of image blocks (if any) + text block with commit message, diff, evaluation score, evaluation topic_summary, PROJECT_NAME, PROJECT_URL, PROJECT_DESCRIPTION from env vars
  - `output_config.format` with `type: 'json_schema'` using POST_JSON_SCHEMA
- Parse response: `JSON.parse(response.content[0].text)`
- Post-process: inject the BlogPosting and FAQPage JSON-LD `<script>` tags into `htmlContent` if not already present (append before closing of content)
- Return the post object

**Update module.exports** to include `generateBlogPost` and `POST_JSON_SCHEMA`.

The Anthropic client should be initialized once at module level (not per-function).
  </action>
  <verify>
    <automated>node -e "const m = require('./scripts/evaluate-commit'); console.assert(typeof m.generateBlogPost === 'function'); console.assert(typeof m.POST_JSON_SCHEMA === 'object'); console.assert(m.POST_JSON_SCHEMA.required.includes('answerFirstBlock')); console.assert(m.POST_JSON_SCHEMA.required.includes('faqItems')); console.assert(m.POST_JSON_SCHEMA.required.includes('blogPostingSchema')); console.assert(m.POST_JSON_SCHEMA.required.includes('faqPageSchema')); console.assert(m.POST_JSON_SCHEMA.properties.faqItems.type === 'array'); console.log('All generation function assertions passed')"</automated>
    <manual>Review the system prompt in buildSystemPrompt() to confirm all brand voice rules, portfolio framing, answer-first block instruction, FAQ generation instruction, schema generation instructions, and locked content decisions are included</manual>
  </verify>
  <done>generateBlogPost function exported, POST_JSON_SCHEMA includes all required fields (title, slug, seoTitle, metaDescription, focusKeyword, excerpt, htmlContent, categories, tags, answerFirstBlock, faqItems, blogPostingSchema, faqPageSchema). System prompt incorporates all brand voice elements and locked content decisions. Claude structured outputs ensure valid JSON without retry logic.</done>
</task>

</tasks>

<verification>
1. `require('./scripts/evaluate-commit')` loads without error
2. `shouldSkipCommit()` returns true for all 5 skip categories
3. `evaluateWorthiness` and `generateBlogPost` are async functions ready for Claude API calls
4. POST_JSON_SCHEMA enforces all required fields including answerFirstBlock, faqItems, blogPostingSchema, faqPageSchema
5. Brand voice module is imported (not duplicated) — `require('./brand-voice')` used
6. WORTHINESS_THRESHOLD defaults to 7 (per locked decision, not 6 from REQUIREMENTS.md)
</verification>

<success_criteria>
- `scripts/evaluate-commit.js` exists and exports shouldSkipCommit, evaluateWorthiness, generateBlogPost, WORTHINESS_THRESHOLD, POST_JSON_SCHEMA
- Skip patterns cover dependabot, merge commits, chore/ci/docs/style/test/build/revert prefixes, and [skip-blog]
- Claude API calls use structured outputs (`output_config.format` with `type: 'json_schema'`) — no JSON.parse retry loops
- System prompt includes brand identity, voice rules, portfolio framing, answer-first instruction, FAQ generation, schema generation, and all locked content decisions
- Module follows CommonJS pattern established in Phase 1
</success_criteria>

<output>
After completion, create `.planning/phases/02-blog-post-generator/02-01-SUMMARY.md`
</output>
